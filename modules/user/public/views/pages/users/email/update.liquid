---
slug: users/email/edit
method: put
---
{% liquid
  function current_profile = 'modules/user/helpers/current_profile'
   if current_profile.user == null
    include 'modules/core/helpers/redirect_to'
  endif

  if current_profile.otp_configured
    function object = 'modules/user/commands/user/verify_otp', object: context.params.user, email: current_profile.user.email
    if object.valid == false
      render 'modules/user/users/email/edit', otp_enabled: current_profile.otp_configured, errors: object.errors
      break
    endif
  endif

  function object = 'modules/user/commands/user/email_update', object: context.params.user, current_user: current_profile.user

  if object.valid
    hash_assign current_profile['email'] = context.params.user.email
    function _ = 'modules/user/commands/profiles/update', object: current_profile, profile: current_profile
    assign event_payload = null | hash_merge: actor_id: object.id, object: object, actor: object, target: null, object_id: null, target_id: null
    function _event = 'modules/core/commands/events/publish', type: 'email_updated', object: event_payload

     assign notice = 'modules/user/users.email.change_success' | t
    include 'modules/core/helpers/redirect_to', url: '/', notice: notice
  else
    render 'modules/user/users/email/edit', object: object, context: context
  endif
%}
