---
slug: profiles/2fa
method: post
---
{% liquid
  function current_profile = 'modules/user/helpers/current_profile'
  if current_profile.id == blank
    redirect_to '/'
  endif

  function object = 'modules/user/commands/user/verify_otp', object: context.params.2fa, email: current_profile.user.email
  if object.valid
    hash_assign current_profile['otp_configured'] = true
    function object = 'modules/user/commands/profiles/mark_otp', object: current_profile
    if object.valid != true
      log object, 'ERROR: modules/user/profiles/mark_otp'
    endif
    assign notice = 'modules/user/2fa.create.success' | t
    include 'modules/core/helpers/redirect_to', url: '/', notice: notice
  else
    function user_otp = 'modules/user/queries/user/otp', email: current_profile.user.email, name: null
    render 'modules/user/2fa/setup', otp: user_otp.otp, errors: object.errors, object: object
  endif
%}
