{% comment %}
  Gets roles and permissions matrix.
{% endcomment %}
{% liquid
  assign anonymous_declared = false
  assign authenticated_declared = false

  graphql defined_roles = 'modules/user/role_permissions/search', per_page: 1000

  assign roles = '[]' | parse_json

  comment
    Check if anonymous and authenticated roles are overridden.
  endcomment
  for row in defined_roles.records.results
    if row.role_name == 'anonymous'
      assign anonymous_declared = true
      assign anonym_permissions = row.permissions
    endif
    if row.role_name == 'authenticated'
      assign authenticated_declared = true
    endif
    assign role = '{}' | parse_json | hash_merge: role_name: row.role_name, permissions: row.permissions
    assign roles = roles | add_to_array: role
  endfor

  function all_permissions = 'modules/permission/lib/queries/permission/search'
  assign auth_permissions = '["sessions.destroy"]' | parse_json
  assign anonym_permissions = anonym_permissions | default: '["sessions.create", "users.register"]' | parse_json

  comment
    Decalre the default roles.
  endcomment
  unless authenticated_declared
    assign role = '{}' | parse_json | hash_merge: role_name: 'authenticated', permissions: auth_permissions
    assign roles = roles | prepend_to_array: role
  endunless
  unless anonymous_declared
    assign role = '{}' | parse_json | hash_merge: role_name: 'anonymous', permissions: anonym_permissions
    assign roles = roles | prepend_to_array: role
  endunless

  comment
    Superadmins should do everything except anonymous ones.
  endcomment
  assign superadmin_permissions = all_permissions | array_subtract: anonym_permissions
  assign role = '{}' | parse_json | hash_merge: role_name: 'superadmin', permissions: superadmin_permissions
  assign roles = roles | prepend_to_array: role

  return roles
%}
